generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id               String            @id @default(uuid())
  name             String
  slug             String            @unique
  logoUrl          String?
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  address          String?
  bankAccount      String?
  bankAgency       String?
  bankName         String?
  email            String?
  idealId          String?
  phone            String?
  taxId            String?
  appointments     Appointment[]
  customers        Customer[]
  employees        Employee[]
  payments         EmployeePayment[]
  feedbacks        Feedback[]
  schedulingConfig SchedulingConfig?
  services         Service[]
  users            User[]
  profiles         PermissionProfile[]
}

model User {
  id              String             @id @default(uuid())
  name            String?
  email           String             @unique
  password        String
  role            Role               @default(CLIENT)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  tenantId        String?
  profileId       String?
  customerProfile Customer?
  employeeProfile Employee?
  profile         PermissionProfile? @relation(fields: [profileId], references: [id])
  tenant          Tenant?            @relation(fields: [tenantId], references: [id])
}

model PermissionProfile {
  id          String      @id @default(uuid())
  name        String
  description String?
  type        ProfileType @default(STAFF)
  permissions String[] // Array of strings like "finance:manage", "team:read", etc.
  tenantId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  users       User[]

  @@unique([name, tenantId])
}

enum ProfileType {
  ADMIN
  STAFF
}

model Customer {
  id               String           @id @default(uuid())
  userId           String           @unique
  address          String?
  city             String?
  zipCode          String?
  phone            String?
  latitude         Float?
  longitude        Float?
  document         String?
  birthDate        DateTime?
  notes            String?
  area             String?
  bedrooms         Int?
  bathrooms        Int?
  footage          String?
  accessInfo       String?
  tenantId         String
  active           Boolean          @default(true)
  type             ClientType       @default(PERSONAL)
  frequency        ServiceFrequency @default(ONE_TIME)
  frequencyDetails String?
  billingDay       Int?
  billingEmail     String?
  appointments     Appointment[]
  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  user             User             @relation(fields: [userId], references: [id])
  invoices         Invoice[]
}

model Employee {
  id           String            @id @default(uuid())
  userId       String            @unique
  color        String?           @default("#000000")
  phone        String?
  latitude     Float?            // Localização em tempo real
  longitude    Float?           // Localização em tempo real
  lastLocationUpdate DateTime?  // Última atualização de posição
  servedAreas  String[]          @default([])
  tenantId     String
  appointments Appointment[]
  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  user         User              @relation(fields: [userId], references: [id])
  payments     EmployeePayment[]
  feedbacks    Feedback[]
}

model Service {
  id           String        @id @default(uuid())
  name         String
  description  String?
  durationMin  Int           @default(60)
  price        Decimal       @default(0.00)
  tenantId     String
  appointments Appointment[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
}

model Appointment {
  id                     String              @id @default(uuid())
  startTime              DateTime
  endTime                DateTime
  status                 AppointmentStatus   @default(PENDING)
  notes                  String?
  address                String
  price                  Decimal
  priority               AppointmentPriority @default(NORMAL)
  actualStartTime        DateTime?
  actualEndTime          DateTime?
  clientConfirmationDate DateTime?
  invoiceId              String?
  customerId             String
  employeeId             String?
  serviceId              String
  tenantId               String
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  tipPrice               Decimal             @default(0.00)
  warnings               String?
  priorityAreas          String?
  customDuration         Int?
  cleanerConfirmationDate DateTime?
  proofImages            String[]            @default([])
  clientNotes            String?
  clientImages           String[]            @default([])
  agreedToTerms          Boolean             @default(false)
  customer               Customer            @relation(fields: [customerId], references: [id])
  employee               Employee?           @relation(fields: [employeeId], references: [id])
  invoice                Invoice?            @relation(fields: [invoiceId], references: [id])
  service                Service             @relation(fields: [serviceId], references: [id])
  tenant                 Tenant              @relation(fields: [tenantId], references: [id])
  feedbacks              Feedback[]
  notifications          NotificationLog[]
}

model Invoice {
  id           String        @id @default(uuid())
  amount       Decimal
  status       String        @default("OPEN")
  dueDate      DateTime
  paidAt       DateTime?
  customerId   String
  paymentLink  String?
  mollieId     String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]
  customer     Customer      @relation(fields: [customerId], references: [id])
}

model EmployeePayment {
  id         String      @id @default(uuid())
  employeeId String
  amount     Decimal
  type       PaymentType @default(SALARY)
  date       DateTime    @default(now())
  notes      String?
  tenantId   String
  employee   Employee    @relation(fields: [employeeId], references: [id])
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
}

model Feedback {
  id            String       @id @default(uuid())
  appointmentId String?
  fromUserId    String
  toEmployeeId  String
  rating        Int          @default(5)
  comment       String?
  type          FeedbackType @default(CLIENT_TO_EMPLOYEE)
  tenantId      String
  createdAt     DateTime     @default(now())
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  tenant        Tenant       @relation(fields: [tenantId], references: [id])
  toEmployee    Employee     @relation(fields: [toEmployeeId], references: [id])
}

model SchedulingConfig {
  id                   String   @id @default(uuid())
  availability         String   @default("{}")
  holidays             String   @default("[]")
  rateNormal           Decimal  @default(50.00)
  rateNormal2          Decimal  @default(75.00)
  rateUrgent           Decimal  @default(100.00)
  minDurationMin       Int      @default(60)
  tenantId             String   @unique
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  allowTeammateRatings Boolean  @default(false)
  enableTips           Boolean  @default(false)
  
  // Configurações de Notificação
  notifyDayBefore       Boolean @default(true)
  notifyOnTheWay        Boolean @default(true)
  notifyServiceStarted  Boolean @default(true)
  notifyServiceFinished Boolean @default(true)
  
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
}

model NotificationLog {
  id            String   @id @default(uuid())
  appointmentId String
  type          String   // DAY_BEFORE, EN_ROUTE, STARTED, FINISHED
  recipient     String
  status        String   // SENT, FAILED
  sentAt        DateTime @default(now())
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
}

enum PaymentType {
  SALARY
  TIP
  BONUS
}

enum FeedbackType {
  CLIENT_TO_EMPLOYEE
  TEAMMATE_RATING
}

enum Role {
  ADMIN
  CLEANER
  CLIENT
  SUPER_ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  EN_ROUTE               // Staff a caminho
  IN_PROGRESS
  AWAITING_CONFIRMATION
  COMPLETED
  CANCELLED
}

enum ClientType {
  PERSONAL
  BUSINESS
}

enum ServiceFrequency {
  ONE_TIME
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum AppointmentPriority {
  NORMAL
  HIGH
  URGENT
}
